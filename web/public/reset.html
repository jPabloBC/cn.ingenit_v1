<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear contraseña CN</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="site-header">
    <div class="brand">
      <a href="/"><img src="/images/IngenIT_5.svg" alt="IngenIT" class="site-logo"></a>
    </div>
  </header>

  <main>
    <section class="contact container contact-section">
      <div class="contact-inner">
        <h2>Crear contraseña</h2>
        <form id="frm">
          <div class="password-field">
            <input id="pw" type="password" placeholder="Nueva contraseña" required minlength="6" />
            <button type="button" class="pw-toggle" data-target="pw" aria-label="Mostrar/ocultar contraseña">
              <!-- eye icon -->
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"></path><circle cx="12" cy="12" r="2.5"/></svg>
            </button>
          </div>
          <div class="password-field">
            <input id="pw2" type="password" placeholder="Confirmar contraseña" required />
            <button type="button" class="pw-toggle" data-target="pw2" aria-label="Mostrar/ocultar contraseña">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5C7 5 2.73 8.11 1 12c1.73 3.89 6 7 11 7s9.27-3.11 11-7c-1.73-3.89-6-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"></path><circle cx="12" cy="12" r="2.5"/></svg>
            </button>
          </div>
          <div style="margin-top:18px">
            <button class="btn btn-email" type="submit">Actualizar</button>
          </div>
          <div class="note" id="msg" style="margin-top:12px;color:var(--gray-4)"></div>
        </form>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-inner container">
      <div class="footer-col footer-brand">
        <img src="/images/logo_transparent_ingenIT_white.png" alt="IngenIT" class="footer-logo">
        <ul class="contact-list">
            <li>+56 9 9020 6618</li>
            <li>gerencia@ingenit.cl</li>
            <li>www.cn.ingenit.cl</li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <div class="container">© 2025 IngenIT ®. Todos los derechos reservados.</div>
    </div>
  </footer>

  <script>
    // password toggle handlers
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.pw-toggle');
      if (!btn) return;
      const targetId = btn.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (!input) return;
      const isPwd = input.getAttribute('type') === 'password';
      input.setAttribute('type', isPwd ? 'text' : 'password');
      // toggle icon: simple swap between eye and eye-off path
      if (isPwd) {
        btn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M2 12s4-7 10-7 10 7 10 7-4 7-10 7S2 12 2 12z"/><path d="M9.5 12a2.5 2.5 0 1 0 5 0 2.5 2.5 0 0 0-5 0z"/></svg>';
      } else {
        btn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M1 1l22 22" stroke="currentColor" stroke-width="2" fill="none"/><path d="M17.94 17.94C16.02 19.3 14.07 20 12 20 7 20 2.73 16.89 1 12c.58-1.31 1.47-2.56 2.57-3.66" fill="none" stroke="currentColor" stroke-width="1.2"/></svg>';
      }
    });

    function getToken() {
      const p = new URLSearchParams(location.search);
      return p.get('token');
    }

    document.getElementById('frm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('msg');
      msg.textContent = '';
      const pw = document.getElementById('pw').value;
      const pw2 = document.getElementById('pw2').value;
      const token = getToken();
      if (!token) { msg.textContent = 'Token faltante en la URL.'; return; }
      if (pw.length < 6 || pw !== pw2) { msg.textContent = 'Contraseñas inválidas o no coinciden.'; return; }

      try {
        // Use local proxy to avoid CORS and preflight redirect issues
        const res = await fetch('/api/proxy/admin/cn/set-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password: pw })
        });

        const contentType = res.headers.get('content-type') || '';
        let bodyText = '';
        let bodyJson = null;
        if (contentType.includes('application/json')) {
          bodyJson = await res.json().catch(()=>null);
        } else {
          bodyText = await res.text().catch(()=>'');
        }

        if (!res.ok) {
          const errMsg = bodyJson?.error || bodyJson?.message || bodyJson?.detail || bodyText;
          msg.textContent = errMsg || `Error ${res.status} al actualizar contraseña`;
          // redirect to error page after short delay so user sees message
          setTimeout(() => { window.location.href = '/reset-error.html'; }, 1800);
          return;
        }

        // on success redirect to success page
        window.location.href = '/reset-success.html';
      } catch (err) {
        msg.textContent = 'Error de red al conectar con el servidor: ' + (err && err.message ? err.message : String(err));
      }
    });
  </script>
</body>
</html>